name: Secure Laravel CI/CD

on:
  push:
    branches: [main]
  pull_request:

jobs:
  build-test-security:
    name: Build, Test, and Secure Laravel App
    runs-on: ubuntu-latest

    steps:
      # 1Ô∏è‚É£ Checkout Code
      - name: Checkout repository
        uses: actions/checkout@v4

      # 2Ô∏è‚É£ Setup PHP environment
      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: 8.2
          extensions: mbstring, intl, pdo_mysql
          coverage: none

      # 3Ô∏è‚É£ Install dependencies
      - name: Install PHP dependencies
        run: composer install --no-interaction --prefer-dist

      - name: Install Node dependencies (optional)
        run: |
          if [ -f package.json ]; then
            npm install
          fi

      # 4Ô∏è‚É£ Run Laravel Tests
      - name: Run PHPUnit tests
        run: php artisan test

      # 5Ô∏è‚É£ Composer Security Audit
      - name: Check for PHP dependency vulnerabilities
        run: composer audit --locked

      # 6Ô∏è‚É£ NPM Audit (optional for Laravel Mix/Vite)
      - name: Check for npm vulnerabilities
        run: |
          if [ -f package.json ]; then
            npm audit --audit-level=moderate || true
          fi

      # 7Ô∏è‚É£ Static Analysis (PHPStan)
      - name: Run static code analysis
        run: |
          if [ -f vendor/bin/phpstan ]; then
            vendor/bin/phpstan analyse --no-progress
          else
            echo "PHPStan not installed, skipping analysis."
          fi

      # 8Ô∏è‚É£ Scan for leaked secrets
      - name: Scan for secrets
        uses: trufflesecurity/trufflehog@v3.66.2
        with:
          path: .
          base: HEAD~1
          head: HEAD
          fail: true


      # 9Ô∏è‚É£ Optional: OWASP ZAP Scan (basic)
      # - name: Run OWASP ZAP baseline scan
      #   uses: zaproxy/action-baseline@v0.7.0
      #   with:
      #     target: 'http://127.0.0.1:8000'
      #   continue-on-error: true

      # üîü Deployment Gate (only runs if all above succeed)
      - name: Ready for deployment
        if: success()
        run: echo "‚úÖ All security and tests passed ‚Äî safe to deploy!"
